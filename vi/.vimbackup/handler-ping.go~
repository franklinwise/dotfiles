package main

import (
	"encoding/json"
	"fmt"
	"net/http"
	"time"

	"github.com/krave-n/go/caching"
	"github.com/krave-n/go/logging"
)

type Pong struct {
	Message string `json:"message"`
}

type Ping struct {
	Number  int    `json:"number,string"`
	Message string `json:"message"`
}

type PingHandler struct {
	cache caching.CacheService `inject:""`
	log   logging.Logger       `inject:""`
}

func (p *PingHandler) PingHandler(w http.ResponseWriter, r *http.Request) {
	p.log.Info("Ping Received")

	message, _ := json.Marshal(&Pong{Message: "pong"})
	w.Write([]byte(message))

	var pong Pong
	pong.Message = fmt.Sprintf("pong %v", time.Now())
	p.cache.Set("last-request", pong)
}

func (p *PingHandler) Get(w http.ResponseWriter, r *http.Request) {
	r.ParseForm()
	ping := new(Ping)
	if err := MapToStruct(r.Form, &ping); err != nil {
		panic(err)
	}

	pong := new(Pong)
	if err := p.cache.Get("last-request", &pong); err != nil {
		panic(err)
	}

	p.log.Info(struct{ CachedValue string }{fmt.Sprintf("%#v", pong)})

	pong.Message = pong.Message + " from cache"
	message, _ := json.Marshal(pong)
	w.Write([]byte(message))
}
